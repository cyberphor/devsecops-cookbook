## Recipe 19

## Backend
The steps below describe how the `backend` was created.

**Step 1.** Create a Python virtual environment called `.venv`.
```bash
python -m venv .venv
```

**Step 2.** Activate the Python virtual environment you just created.
```bash
source .venv/bin/activate
```

**Step 3.** Install a Python web app framework Django.
```bash
pip install django djangorestframework
```

**Step 4.** Create a directory called `backend` and change directories to it.
```bash
mkdir backend &&\
cd backend
```

**Step 5.** Create a Django project called `backend` in the `backend` directory.
```bash
django-admin startproject backend .
```

**Step 6.** Open the file called `settings.py` in the `backend/backend` directory and make sure it looks like below.
```python
"""
Django settings for backend project.

Generated by 'django-admin startproject' using Django 5.2.3.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/5.2/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-u8^#*!f@4%gpodaniz_7*x8vv^92d!5nccb_1-m!msjr9#lp*6'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    'squidfall.middleware.ContentSecurityPolicyNonceMiddleware',
]

ROOT_URLCONF = 'backend.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [
            'squidfall/templates'
        ],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'backend.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'
STATICFILES_DIRS = [
    BASE_DIR / "../frontend/squidfall/dist/assets",
]

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
```

**Step 6.** Open the file called `urls.py` in the `backend/backend` directory and make sure it looks like below.
```python
from django.contrib import admin
from django.urls import path
from squidfall.views import index

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', index, name='home'),
]
```

**Step 7.** Create a Django application called `squidfall` in the `backend` directory.
```bash
django-admin startapp squidfall 
```

**Step 8.** Create a file called `middleware.py` in the `backend/squidfall` directory and add the content below to it. 
```python
import base64
import os

class ContentSecurityPolicyNonceMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        nonce = base64.b64encode(os.urandom(16)).decode('utf-8')
        request.csp_nonce = nonce
        response = self.get_response(request)
        csp = (
            f"default-src 'self'; "
            f"script-src 'self' 'nonce-{nonce}'; "
            f"style-src 'self' 'nonce-{nonce}';"
        )
        response['Content-Security-Policy'] = csp
        return response
```

**Step 9.** Open the file called `views.py` in the `backend/squidfall` directory and make sure it looks like below.
```python
from django.http import HttpResponse
from django.template import loader


def index(request):
    template = loader.get_template(template_name="index.html")

    # Get the 'csp_nonce' value generated by middleware and use it in the template.
    context = {
        'csp_nonce': getattr(request, 'csp_nonce')
    }
    return HttpResponse(content=template.render(context, request))
```

**Step 10.** Run the commands below. 
```bash
python -m manage makemigrations
python -m manage migrate
```

**Step 11.** Build the frontend.

**Step 12.** Make a directory called `templates` in the `backend/squidfall` directory. Then, create a file called `index.html` and add the content below to it. 
```html
{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csp-nonce" content="{{ csp_nonce }}">
    <script type="module" src="{% static 'index-CMRY0jNb.js' %}" nonce="{{ csp_nonce }}"></script>
    <title>Toolpad Core App</title>
  </head>
  <body>
    <div id="root"></div>
  </body>
</html>
```

**Step 13.** Run the command below. 
```bash
python manage.py collectstatic
```

**Step 14.** Start the backend from the `backend` directory (where `manage.py` is located).
```bash
python -m manage runserver
```

## Frontend
The steps below describe how the `frontend` was created.

**Step 1.** Create a folder called `frontend` and change directories to it.
```bash
mkdir frontend &&\
cd frontend
```

**Step 2.** Install the Node Version Manager (NVM) if it's not already installed.
```bash
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
```

**Step 3.** Copy, paste, and run the commands printed in the previous step.
```bash
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
```

**Step 4.** Use NVM to install the latest copy of Node.js (Node), the Node Package Manager (NPM), and Node Package Execute (NPX).
```bash
nvm install node
```

**Step 5.** To confirm what version of Node is installed, enter the command below. 
```bash
node --version
```

You should get output similar to below. 
```
v24.2.0
```

**Step 6.** To confirm what version of NPM and NPX are installed, enter the command below. 
```bash
npm --version
```

You should get output similar to below. 
```
11.3.0
```

**Step 7.** Use NPX to create a new Material UI (MUI) Toolpad Core project called `squidfall`. FYI, Material UI's Toolpad Core framework uses Emotion for styling. Therefore you must add additional configuration to Emotion to implement a Content Security Policy (CSP). As long as your request headers include the right nonce, Toolpad Core's scripts and styling will be rendered. 
```bash
npx create-toolpad-app@latest squidfall
```

You will be prompted with the following questions.
```
✔ Which framework would you like to use? Vite
✔ Would you like to enable authentication? no
```

**Step 8.** Open the file called `vite.config.mts` within the root directory of your Toolpad Core project's directory and then, copy and paste the content below to it.
```ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// https://vitejs.dev/config/
export default defineConfig({
  plugins: [react()],
  build: {
    // Disable using URIs for data directives (e.g., img-src, font-src).
    assetsInlineLimit: 0,
  }
});
```

**Step 9.** Open the file called `App.tsx` within the `src` directory of your Toolpad Core project's directory and then, copy and paste the content below to it.
```ts
import * as React from 'react';
import DashboardIcon from '@mui/icons-material/Dashboard';
import PersonIcon from '@mui/icons-material/Person';
import { Outlet } from 'react-router';
import { ReactRouterAppProvider } from '@toolpad/core/react-router';
import type { Navigation } from '@toolpad/core/AppProvider';
import { CacheProvider } from '@emotion/react';
import createCache from '@emotion/cache';

const NAVIGATION: Navigation = [
  {
    kind: 'header',
    title: 'Main items',
  },
  {
    title: 'Dashboard',
    icon: <DashboardIcon />,
  },
  {
    segment: 'employees',
    title: 'Employees',
    icon: <PersonIcon />,
    pattern: 'employees{/:employeeId}*',
  },
];

const BRANDING = {
  title: "squidfall",
};

const nonce = document
  .querySelector('meta[name="csp-nonce"]')
  ?.getAttribute('content') || 'not-set';

const cache = createCache({
  key: 'css',
  nonce: nonce,
  prepend: true
});


export default function App() {
  return (
    <CacheProvider value={cache}>
      <ReactRouterAppProvider navigation={NAVIGATION} branding={BRANDING}>
        <Outlet />
      </ReactRouterAppProvider>
    </CacheProvider>
  );
}
```


## References
* [Material UI: Learn how to install Toolpad Core in your local environment.](https://mui.com/toolpad/core/introduction/installation/)
* [Material UI: Content Security Policy](https://mui.com/material-ui/guides/content-security-policy/)
* [Next.js: How to set a Content Security Policy (CSP) for your Next.js application](https://nextjs.org/docs/app/guides/content-security-policy)